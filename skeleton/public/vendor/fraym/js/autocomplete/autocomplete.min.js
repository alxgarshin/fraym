class FraymAutocomplete{constructor(element,options){return!!element&&(!_(element).hasClass("fraymAutocompleteApplied")&&(this.element=this.input=_(element),this.element.addClass("fraymAutocompleteApplied"),this.value=null,this.options={classPrefix:"autocomplete"},this.options=Object.assign(this.options,{source:null,minLength:3,makeEmptySearches:!1,conditionalSearch:!1,contiditionalMarker:"@",contiditionalMarkerBreakOn:"]",inputClass:`${this.options.classPrefix}-input`,emptyMessageElement:null,emptyMessageClass:`${this.options.classPrefix}-empty-message`,resultsContainerElement:null,resultsContainerClass:`${this.options.classPrefix}-results-container`,select:function(){},change:function(){},response:function(data){0===data.length?(this.emptyMessageElement.show(),this.resultsContainerElement.hide()):(this.emptyMessageElement.hide(),this.resultsContainerElement.show())}},options),this.source=this.options.source,this.data=[],this.input.addClass(this.options.inputClass),this.emptyMessageElement=_(this.options.emptyMessageElement??elNew("div")).addClass(this.options.emptyMessageClass).hide(),this.resultsContainerElement=_(this.options.resultsContainerElement??elNew("div")).addClass(this.options.resultsContainerClass).hide(),this.options.emptyMessageElement||(this.input.insert(this.emptyMessageElement.asDomElement(),"after"),this.emptyMessageElement.text(LOCALE.nothing_found)),this.options.resultsContainerElement||this.emptyMessageElement.insert(this.resultsContainerElement.asDomElement(),"after"),this.input.on("show"+(this.options.conditionalSearch?"":" focusin"),(()=>{0===this.data.length?(this.emptyMessageElement.show(),this.resultsContainerElement.hide()):(this.emptyMessageElement.hide(),this.resultsContainerElement.show())})),this.input.on("focusout",(()=>{delay(100).then((()=>{this.emptyMessageElement.hide(),this.resultsContainerElement.hide()}))})),void this.input.on("keyup change activate",this.handleInput.bind(this))))}handleInput(e){const input=e.target,autocomplete=this;let value=input.value,currentPosition=0,closestIndice=0;if(this.options.conditionalSearch)if(value.indexOf(this.options.contiditionalMarker)>=0){currentPosition=getCursorPosition(input),currentPosition<=value.indexOf(this.options.contiditionalMarker)&&(currentPosition=value.indexOf(this.options.contiditionalMarker)+1);let indices=[];for(let pos=value.indexOf(this.options.contiditionalMarker);-1!==pos;pos=value.indexOf(this.options.contiditionalMarker,pos+1))indices.push(pos);for(let i=0;i<indices.length;i++)indices[i]>=closestIndice&&indices[i]<currentPosition&&(closestIndice=indices[i]);value=value.substring(closestIndice+1,currentPosition),value.match(this.options.contiditionalMarkerBreakOn)?value=null:this.input.trigger("show")}else value=null;(value||autocomplete.options.makeEmptySearches)&&autocomplete.value!==value&&(autocomplete.options.change.call(autocomplete,value),value.length>=this.options.minLength||!value&&autocomplete.options.makeEmptySearches?(window.clearTimeout(window.autocomplete_search),window.autocomplete_search=setTimeout((function(){const sourceHasQuestionMark=-1!==autocomplete.source.indexOf("?");!value&&autocomplete.options.makeEmptySearches&&(value="base"),fetchData(`${autocomplete.source}${sourceHasQuestionMark?"&":"?"}term=${value}`,{method:"GET",json:!0}).then((data=>{autocomplete.value=value,autocomplete.data=[],autocomplete.resultsContainerElement.empty(),data.forEach((item=>{autocomplete.options.conditionalSearch&&(item.currentPosition=currentPosition,item.closestIndice=closestIndice),autocomplete.data.push(item);const itemElement=elFromHTML(`<div class="item${item.class?" "+item.class:""}">${item.value}</div>`);autocomplete.resultsContainerElement.insert(itemElement,"end"),itemElement.addEventListener("click",(function(){autocomplete.value=item.value,autocomplete.options.conditionalSearch||autocomplete.input.val(item.value),autocomplete.emptyMessageElement.hide(),autocomplete.resultsContainerElement.hide(),autocomplete.options.select.call(item)}))})),autocomplete.options.response.call(autocomplete,autocomplete.data)})).catch((error=>{console.error(error)}))}),200)):autocomplete.options.conditionalSearch||(autocomplete.data=[],autocomplete.resultsContainerElement.empty(),this.input.trigger("show")))}}